## MITRE | ATT&CK <a href="https://attack.mitre.org/techniques/T1566/001/">T1566.001</a>
### Tactic: Initial Access 
#### Scenario objective
The objective of this scenario is early detection of malicious files before execution.
This is achieved through VirusTotal integration, real-time File Integrity Monitoring (FIM), and an automated response that removes the infected file.
#### Scenario
The user downloaded a malicious file from an untrusted source or received it via a phishing email, after which the file was saved in the Downloads folder.
This scenario reflects one of the most common real-world infection vectors observed in enterprise environments.
#### Walkthrough 

<b>Step 1 | Configuring Agents </b> <p>Adding folder monitoring on Windows host in agent.conf  ( * in path for all users in agents )</p>
<p><b>PS!</b> We can also add restrict=".exe|.dll|.js|.bat|.ps1" in directories value but for my test i won't</p>

```
  <agent_config os="Windows">
    <syscheck>
      <directories check_all="yes" realtime="yes"> C:\Users\*\Downloads </directories>
    </syscheck>
  </agent_config>
```
alert ⚠ Check.
<img width="1280" height="448" alt="image" src="https://github.com/user-attachments/assets/4f6b59b9-2950-4e93-9304-eb804c9ae2ef" />

<b>2. VirusTotal integration to Wazuh server</b>
<p><b>Requierments: VirusTotal API_KEY</b>
  
```
<integration>
  <name>virustotal</name>
  <api_key>API_KEY</api_key> <!-- Replace with your VirusTotal API key -->
  <group>syscheck</group>
  <alert_format>json</alert_format>
</integration>
```

Integration Check ⚠ 
<img width="951" height="686" alt="image" src="https://github.com/user-attachments/assets/d7c438be-c399-4a69-8ff7-3878aafdc919" />

<b>Issue 1 | FIM testing </b>
<p>My second host is Windows 10 Pro. Creating a new file via Windows Explorer does not consistently trigger a FIM event (as shown in the screenshot, the files are 0 KB). To reliably generate a FIM event, I created the file using PowerShell with actual content, which immediately resulted in an event being detected by Wazuh.</p>
<img width="1124" height="957" alt="win10proFIM" src="https://github.com/user-attachments/assets/32ae7828-5e97-4c7c-8740-f75e11096383" />
( Wazuh screenshot ) 
<img width="1913" height="555" alt="image" src="https://github.com/user-attachments/assets/fd8dd985-ad65-457d-9b5c-2c8559e27ab2" />

<b>Issue 2 | Windows Virus & Threat protection </b>
<p>Windows(10, 11)  has their own threat protections, which immediately response to suspicious installed files by deleting them, so in my test case i turned it off</p>

<b>Step 2 | Testing VirusTotal alert </b>
<p>VirusTotal alerted in Wazuh Threat Detection Event with code 87105 ( 87104 for No positives found )</p>
<img width="1919" height="604" alt="image" src="https://github.com/user-attachments/assets/dab8a173-2944-4a32-a731-4dafdaa0b228" />
<p>More Event details</p>
<img width="958" height="864" alt="image" src="https://github.com/user-attachments/assets/a05aceff-427c-4a5b-b17f-7ec4c0601294" />
<p>VirustTotal Scoring and details</p>
<img width="1317" height="822" alt="image" src="https://github.com/user-attachments/assets/edd15e3d-5181-4534-b47e-266074c51fa9" />

<b>Step 3 | Implementing active Response </b>
<p>In this step, an active response command was configured on the Wazuh Manager, while the response script itself was deployed on the endpoint (Windows agent).
The script is responsible for automatically removing malicious files after detection.

After successfully creating the removal script and configuring the Wazuh Manager accordingly (as described in the <a href="https://documentation.wazuh.com/current/proof-of-concept-guide/detect-remove-malware-virustotal.html">Proof Of Concept Guide </a>), I started testing the automated response workflow.
Once a malicious file was detected, a Wazuh alert was triggered and the active response executed on the affected host.</p>

<p> Wazuh Alert triggered </p>

![WazuhThreatremove](https://github.com/user-attachments/assets/c0c0ccf6-e6ba-4614-aacb-fbc1b638d985)

<p> Active Response detailed </p>

![WazuhThreatRemove2](https://github.com/user-attachments/assets/87cf38b2-fd19-4efc-b9d4-e9077ed87a5a)

### Conclusion

